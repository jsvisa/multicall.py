from multicall.eth_decode import eth_decode_input, abi_to_signature_with_arguments
from tests.testdata import (
    ABI_swapETHForSpecificNFTs,
    ABI_matchAdvancedOrders,
    ABI_claim,
    ABI_execute,
    ABI_swapExactTokenForPt,
)


class TestEthDecode:
    def test_eth_decode_input(self):
        abi = ABI_swapETHForSpecificNFTs

        data = "0x111320000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000ca6f3defbc6041299837725f6430f33b0f24e5c0000000000000000000000000ca6f3defbc6041299837725f6430f33b0f24e5c00000000000000000000000000000000000000000000000000000000062e9ca1800000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000575570f62c90a61763b1e93cf0da62ed810dbda2000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000561"  # noqa
        func_text, parameter = eth_decode_input(abi, data)
        WANT = "swapETHForSpecificNFTs((address,uint256[])[],address,address,uint256)"  # noqa
        assert func_text == WANT
        assert parameter == {
            "swapList": [
                {
                    "pair": "0x575570f62c90a61763b1e93cf0da62ed810dbda2",
                    "nftIds": (1377,),
                }
            ],
            "ethRecipient": "0xca6f3defbc6041299837725f6430f33b0f24e5c0",
            "nftRecipient": "0xca6f3defbc6041299837725f6430f33b0f24e5c0",
            "deadline": 1659488792,
        }

    def test_eth_decode_input_execute(self):
        abi = ABI_execute

        data = "0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000066315593000000000000000000000000000000000000000000000000000000000000000300060c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000158f681b29fbc7873c90000000000000000000000000000000000000000000000007b5809110e99138900000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002b808507121b80c02388fad14726482e061b8da827000bb8c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000037a8f295612602f2774d331e562be9e61b83a3270000000000000000000000000000000000000000000000000000000000000019000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000007b5809110e991389"

        func, args = eth_decode_input(abi, data)
        assert func == "execute(bytes,bytes[],uint256)"
        print(args)
        assert args == {
            "commands": "00060c",
            "inputs": [
                "0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000158f681b29fbc7873c90000000000000000000000000000000000000000000000007b5809110e99138900000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002b808507121b80c02388fad14726482e061b8da827000bb8c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000",
                "000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000037a8f295612602f2774d331e562be9e61b83a3270000000000000000000000000000000000000000000000000000000000000019",
                "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000007b5809110e991389",
            ],
            "deadline": 1714509203,
        }

    def test_eth_decode_multi_byte_array(self):
        abi = ABI_claim

        # https://etherscan.io/tx/0xfa16ee8660efb99f1f81a75d3254bbd27c4b5b2774db3d6f9ec4a943d96f64e2
        data = "0x71ee95c0000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000934f719cd3fadef7bb30e297f6687ad978a076b700000000000000000000000000000000000000000000000000000000000000010000000000000000000000006b3595068778dd592e39a122f4f5a5cf09c90fe2000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000030afb97e9507ab9550000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000ad162b50e03f5ca065f5f13cd2c65744877194219a9a1520ebe8b4327eaa509945375d3fedbaa836660791c66775eacfade558aceebb8aecab8940b138a844a601779ad5dd4897e835a3777d177d4dc6019a4ba46ea2713f7466f164458159ab5e13f0480977ba1694945183bd8bb1c216c45da56aa82b33c2995db3cf3c15f07ec01f7626fa2122f179696264b402448db62de07899f9a68e511f1c7a1068ab99b5feef23af33b9eebaa2cd394e323f750fae3fc0b8cc67208c550cc760cc2b74c70f9b89b51ceb082c87778b56f4e01086d18ea7afc89b4824f025e376241feabc79489f4f479f6c1e810396cf5038944a392a797eee460d811e3988dacd496eaafbe1e0cf599e83e51c86a9dbde94acdbdd11a0f4d818cc79afc31332256bf0a20eef93fc442a1e6f2f9b23267ee74ecafa475501097cb80ad83da61606a75"  # noqa
        func_text, parameter = eth_decode_input(abi, data)
        WANT = "claim(address[],address[],uint256[],bytes32[][])"  # noqa
        assert func_text == WANT
        assert parameter == {
            "users": ("0x934f719cd3fadef7bb30e297f6687ad978a076b7",),
            "tokens": ("0x6b3595068778dd592e39a122f4f5a5cf09c90fe2",),
            "amounts": (14369696104702900000000,),
            "proofs": [
                [
                    "d162b50e03f5ca065f5f13cd2c65744877194219a9a1520ebe8b4327eaa50994",
                    "5375d3fedbaa836660791c66775eacfade558aceebb8aecab8940b138a844a60",
                    "1779ad5dd4897e835a3777d177d4dc6019a4ba46ea2713f7466f164458159ab5",
                    "e13f0480977ba1694945183bd8bb1c216c45da56aa82b33c2995db3cf3c15f07",
                    "ec01f7626fa2122f179696264b402448db62de07899f9a68e511f1c7a1068ab9",
                    "9b5feef23af33b9eebaa2cd394e323f750fae3fc0b8cc67208c550cc760cc2b7",
                    "4c70f9b89b51ceb082c87778b56f4e01086d18ea7afc89b4824f025e376241fe",
                    "abc79489f4f479f6c1e810396cf5038944a392a797eee460d811e3988dacd496",
                    "eaafbe1e0cf599e83e51c86a9dbde94acdbdd11a0f4d818cc79afc31332256bf",
                    "0a20eef93fc442a1e6f2f9b23267ee74ecafa475501097cb80ad83da61606a75",
                ]
            ],
        }

    def test_eth_decode_opensea_abi(self):
        abi = ABI_matchAdvancedOrders
        data = "0xf2d12b1200000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000ae00000000000000000000000000000000000000000000000000000000000000be00000000000000000000000001f818fef67fd1de70ed02f434f83455e3c754ecb0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005a000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000046000000000000000000000000000000000000000000000000000000000000004c00000000000000000000000004a7eaaab1cb4c26e385b8f033d79a065f9dabc06000000000000000000000000000000e7ec00e7b300774b00001314b8610022b80000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000064f88f2c000000000000000000000000000000000000000000000000000000006501c9950000000000000000000000000000000000000000000000000000000000000000360c6ebe000000000000000000000000000000000000000006c1d8bcf411f5d70000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f0000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006a94d74f430000000000000000000000000000000000000000000000000000006a94d74f43000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000cd041f40d497038e2da65988b7d7e2c0d92446190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000004a7eaaab1cb4c26e385b8f033d79a065f9dabc060000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002aa1efb94e0000000000000000000000000000000000000000000000000000002aa1efb94e0000000000000000000000000000000a26b00c1f0df003000390027140000faa71900000000000000000000000000000000000000000000000000000000000000409f136c3cafe574732c29b22078569d9d0e4dfaccc8b4d8f1eea3a73cac6df2d9f38231cac8de48753e773ed952bd4b3c83b07dd6feab5f4e495920d3e1a5d010000000000000000000000000000000000000000000000000000000000000007e001f818fef67fd1de70ed02f434f83455e3c754ecb0000000064f980e16c4bbfd25c368a5609b719a26116dd854d7bf7c2f49333627645ecbf2cc03ca0c062bd40fde389b5a2e736a33de610ce5e8ee862fd6dde453e9fbc368336ec620000000000000000000000000000000000000000000000000000000000000005a4000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000046000000000000000000000000000000000000000000000000000000000000004800000000000000000000000001f818fef67fd1de70ed02f434f83455e3c754ecb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000064f88f2c000000000000000000000000000000000000000000000000000000006501c9950000000000000000000000000000000000000000000000000000000000000000360c6ebe0000000000000000000000000000000000000000499debe13b4f982e0000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f0000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000cd041f40d497038e2da65988b7d7e2c0d924461900000000000000000000000000000000000000000000000000000000000005a40000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044364c5bb000000000000000000000000000000000000000000000000000000044364c5bb0000000000000000000000000000dc4bca7958000ef99e8c3dc5a63707d3c2a1c39e0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000063a7538df320000000000000000000000000000000000000000000000000000063a7538df320000000000000000000000000001f818fef67fd1de70ed02f434f83455e3c754ecb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005a400000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000002800000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000360c6ebe"  # noqa

        func_text, parameter = eth_decode_input(abi, data)
        WANT = "matchAdvancedOrders(((address,address,(uint8,address,uint256,uint256,uint256)[],(uint8,address,uint256,uint256,uint256,address)[],uint8,uint256,uint256,bytes32,uint256,bytes32,uint256),uint120,uint120,bytes,bytes)[],(uint256,uint8,uint256,uint256,bytes32[])[],((uint256,uint256)[],(uint256,uint256)[])[],address)"  # noqa

        assert func_text == WANT
        assert parameter == {
            "orders": [
                {
                    "parameters": {
                        "offerer": "0x4a7eaaab1cb4c26e385b8f033d79a065f9dabc06",
                        "zone": "0x000000e7ec00e7b300774b00001314b8610022b8",
                        "offer": [
                            {
                                "itemType": 1,
                                "token": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2",
                                "identifierOrCriteria": 0,
                                "startAmount": 30000000000000000,
                                "endAmount": 30000000000000000,
                            }
                        ],
                        "consideration": [
                            {
                                "itemType": 4,
                                "token": "0xcd041f40d497038e2da65988b7d7e2c0d9244619",
                                "identifierOrCriteria": 0,
                                "startAmount": 1,
                                "endAmount": 1,
                                "recipient": "0x4a7eaaab1cb4c26e385b8f033d79a065f9dabc06",
                            },
                            {
                                "itemType": 1,
                                "token": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2",
                                "identifierOrCriteria": 0,
                                "startAmount": 750000000000000,
                                "endAmount": 750000000000000,
                                "recipient": "0x0000a26b00c1f0df003000390027140000faa719",
                            },
                        ],
                        "orderType": 2,
                        "startTime": 1694011180,
                        "endTime": 1694615957,
                        "zoneHash": "0000000000000000000000000000000000000000000000000000000000000000",
                        "salt": 24446860302761739304752683030156737591518664810215442929800869596976045487575,
                        "conduitKey": "0000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f0000",
                        "totalOriginalConsiderationItems": 2,
                    },
                    "numerator": 1,
                    "denominator": 1,
                    "signature": "9f136c3cafe574732c29b22078569d9d0e4dfaccc8b4d8f1eea3a73cac6df2d9f38231cac8de48753e773ed952bd4b3c83b07dd6feab5f4e495920d3e1a5d010",
                    "extraData": "001f818fef67fd1de70ed02f434f83455e3c754ecb0000000064f980e16c4bbfd25c368a5609b719a26116dd854d7bf7c2f49333627645ecbf2cc03ca0c062bd40fde389b5a2e736a33de610ce5e8ee862fd6dde453e9fbc368336ec620000000000000000000000000000000000000000000000000000000000000005a4",
                },
                {
                    "parameters": {
                        "offerer": "0x1f818fef67fd1de70ed02f434f83455e3c754ecb",
                        "zone": "0x0000000000000000000000000000000000000000",
                        "offer": [
                            {
                                "itemType": 2,
                                "token": "0xcd041f40d497038e2da65988b7d7e2c0d9244619",
                                "identifierOrCriteria": 1444,
                                "startAmount": 1,
                                "endAmount": 1,
                            }
                        ],
                        "consideration": [
                            {
                                "itemType": 1,
                                "token": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2",
                                "identifierOrCriteria": 0,
                                "startAmount": 1200000000000000,
                                "endAmount": 1200000000000000,
                                "recipient": "0xdc4bca7958000ef99e8c3dc5a63707d3c2a1c39e",
                            },
                            {
                                "itemType": 1,
                                "token": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2",
                                "identifierOrCriteria": 0,
                                "startAmount": 28050000000000000,
                                "endAmount": 28050000000000000,
                                "recipient": "0x1f818fef67fd1de70ed02f434f83455e3c754ecb",
                            },
                        ],
                        "orderType": 0,
                        "startTime": 1694011180,
                        "endTime": 1694615957,
                        "zoneHash": "0000000000000000000000000000000000000000000000000000000000000000",
                        "salt": 24446860302761739304752683030156737591518664810215442929805687343723960047662,
                        "conduitKey": "0000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f0000",
                        "totalOriginalConsiderationItems": 2,
                    },
                    "numerator": 1,
                    "denominator": 1,
                    "signature": "",
                    "extraData": "",
                },
            ],
            "criteriaResolvers": [
                {
                    "orderIndex": 0,
                    "side": 1,
                    "index": 0,
                    "identifier": 1444,
                    "criteriaProof": [],
                }
            ],
            "fulfillments": [
                {
                    "offerComponents": [{"orderIndex": 1, "itemIndex": 0}],
                    "considerationComponents": [{"orderIndex": 0, "itemIndex": 0}],
                },
                {
                    "offerComponents": [{"orderIndex": 0, "itemIndex": 0}],
                    "considerationComponents": [{"orderIndex": 0, "itemIndex": 1}],
                },
                {
                    "offerComponents": [{"orderIndex": 0, "itemIndex": 0}],
                    "considerationComponents": [{"orderIndex": 1, "itemIndex": 0}],
                },
                {
                    "offerComponents": [{"orderIndex": 0, "itemIndex": 0}],
                    "considerationComponents": [{"orderIndex": 1, "itemIndex": 1}],
                },
            ],
            "recipient": "0x1f818fef67fd1de70ed02f434f83455e3c754ecb",
        }

    def test_abi_to_signature_with_arguments(self):
        abies = [
            (
                ABI_swapETHForSpecificNFTs,
                "swapETHForSpecificNFTs((address pair, uint256[] nftIds)[]swapList, address ethRecipient, address nftRecipient, uint256 deadline)",
            ),
            (
                ABI_matchAdvancedOrders,
                "matchAdvancedOrders(((address offerer, address zone, (uint8 itemType, address token, uint256 identifierOrCriteria, uint256 startAmount, uint256 endAmount)[]offer, (uint8 itemType, address token, uint256 identifierOrCriteria, uint256 startAmount, uint256 endAmount, address recipient)[]consideration, uint8 orderType, uint256 startTime, uint256 endTime, bytes32 zoneHash, uint256 salt, bytes32 conduitKey, uint256 totalOriginalConsiderationItems)parameters, uint120 numerator, uint120 denominator, bytes signature, bytes extraData)[]orders, (uint256 orderIndex, uint8 side, uint256 index, uint256 identifier, bytes32[] criteriaProof)[]criteriaResolvers, ((uint256 orderIndex, uint256 itemIndex)[]offerComponents, (uint256 orderIndex, uint256 itemIndex)[]considerationComponents)[]fulfillments, address recipient)",
            ),
            (
                ABI_claim,
                "claim(address[] users, address[] tokens, uint256[] amounts, bytes32[][] proofs)",
            ),
            (
                ABI_swapExactTokenForPt,
                "swapExactTokenForPt(address receiver, address market, uint256 minPtOut, (uint256 guessMin, uint256 guessMax, uint256 guessOffchain, uint256 maxIteration, uint256 eps)guessPtOut, (address tokenIn, uint256 netTokenIn, address tokenMintSy, address pendleSwap, (uint8 swapType, address extRouter, bytes extCalldata, bool needScale)swapData)input, (address limitRouter, uint256 epsSkipMarket, ((uint256 salt, uint256 expiry, uint256 nonce, uint8 orderType, address token, address YT, address maker, address receiver, uint256 makingAmount, uint256 lnImpliedRate, uint256 failSafeRate, bytes permit)order, bytes signature, uint256 makingAmount)[]normalFills, ((uint256 salt, uint256 expiry, uint256 nonce, uint8 orderType, address token, address YT, address maker, address receiver, uint256 makingAmount, uint256 lnImpliedRate, uint256 failSafeRate, bytes permit)order, bytes signature, uint256 makingAmount)[]flashFills, bytes optData))",
            ),
        ]

        for abi, want in abies:
            have = abi_to_signature_with_arguments(abi)
            assert have == want, have
